{% extends "base_pro.html" %}

{% block title %}Settings - FNIRSI USB Monitor Professional{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="control-bar glass-pro" style="margin-bottom: 1rem; padding: 1rem;">
        <h1 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.35rem; color: var(--text-primary); letter-spacing: 1px;">SETTINGS</h1>
        <p style="color: var(--text-secondary); font-size: 0.8rem;">Configure device connections, alerts, and display options</p>
    </div>

    <!-- Settings Grid -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1rem;">

        <!-- Bluetooth Scanner -->
        <div class="control-bar glass-pro" style="padding: 1rem;">
            <h2 style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.65rem; color: var(--accent-blue); letter-spacing: 1px;">
                <svg style="display: inline-block; width: 16px; height: 16px; margin-right: 0.4rem; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.71 7.71L12 2h-1v7.59L6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM13 5.83l1.88 1.88L13 9.59V5.83zm1.88 10.46L13 18.17v-3.76l1.88 1.88z"/>
                </svg>
                BLUETOOTH DEVICES
            </h2>

            <!-- Manual Address Entry -->
            <div class="setting-item-pro" style="margin-bottom: 0.5rem;">
                <label class="setting-label-pro">DEVICE ADDRESS (MANUAL)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="bt-address" placeholder="98:DA:B0:10:7C:77" class="setting-input-pro" style="flex: 1; font-family: monospace;">
                    <button onclick="connectManualAddress()" class="btn-pro btn-success" style="padding: 0.5rem 1rem;">
                        CONNECT
                    </button>
                </div>
                <div style="font-size: 0.65rem; color: var(--text-tertiary); margin-top: 0.25rem;">
                    Enter address if device is already paired to system Bluetooth
                </div>
            </div>

            <div style="text-align: center; color: var(--text-tertiary); font-size: 0.7rem; margin: 0.5rem 0;">— OR —</div>

            <button onclick="scanBluetooth()" id="btn-scan" class="btn-pro btn-primary" style="width: 100%; margin-bottom: 0.65rem;">
                <svg class="btn-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                SCAN FOR UNPAIRED DEVICES
            </button>

            <div id="scan-results" style="display: flex; flex-direction: column; gap: 0.5rem; min-height: 70px;">
                <div style="text-align: center; color: var(--text-tertiary); font-size: 0.75rem; padding: 1.25rem 0;">
                    Scan finds unpaired devices only. Use manual entry for paired devices.
                </div>
            </div>
        </div>

        <!-- Alert Thresholds -->
        <div class="control-bar glass-pro" style="padding: 1rem;">
            <h2 style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.65rem; color: var(--accent-red); letter-spacing: 1px;">
                <svg style="display: inline-block; width: 16px; height: 16px; margin-right: 0.4rem; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                ALERT THRESHOLDS
            </h2>

            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div class="setting-item-pro">
                    <label class="setting-label-pro">MAX VOLTAGE (V)</label>
                    <input type="number" id="threshold-max-voltage" value="21.0" step="0.1" class="setting-input-pro">
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">MIN VOLTAGE (V)</label>
                    <input type="number" id="threshold-min-voltage" value="3.0" step="0.1" class="setting-input-pro">
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">MAX CURRENT (A)</label>
                    <input type="number" id="threshold-max-current" value="6.0" step="0.1" class="setting-input-pro">
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">MAX POWER (W)</label>
                    <input type="number" id="threshold-max-power" value="120.0" step="1" class="setting-input-pro">
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">MAX TEMPERATURE (°C)</label>
                    <input type="number" id="threshold-max-temp" value="80.0" step="1" class="setting-input-pro">
                </div>

                <button onclick="saveThresholds()" class="btn-pro btn-primary" style="width: 100%; margin-top: 0.25rem;">
                    <svg class="btn-icon" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    SAVE THRESHOLDS
                </button>
            </div>
        </div>

        <!-- Display Settings -->
        <div class="control-bar glass-pro" style="padding: 1rem;">
            <h2 style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.65rem; color: var(--accent-purple); letter-spacing: 1px;">
                <svg style="display: inline-block; width: 16px; height: 16px; margin-right: 0.4rem; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3l-1 1v2h12v-2l-1-1h3c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 13H4V5h16v11z"/>
                </svg>
                DISPLAY SETTINGS
            </h2>

            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                <div class="setting-item-pro">
                    <label class="setting-label-pro">UPDATE RATE</label>
                    <select id="update-rate" class="setting-input-pro">
                        <option value="fast">FAST (Every reading)</option>
                        <option value="normal" selected>NORMAL (10Hz)</option>
                        <option value="slow">SLOW (5Hz)</option>
                    </select>
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">CHART ANIMATION</label>
                    <select id="chart-animation" class="setting-input-pro">
                        <option value="none" selected>NONE (Best performance)</option>
                        <option value="fast">FAST</option>
                        <option value="smooth">SMOOTH</option>
                    </select>
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">MAX DATA POINTS</label>
                    <select id="max-points" class="setting-input-pro">
                        <option value="500" selected>500 POINTS</option>
                        <option value="1000">1000 POINTS</option>
                        <option value="2000">2000 POINTS</option>
                    </select>
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">
                        <span>SHOW GRID</span>
                        <input type="checkbox" id="show-grid" checked class="toggle-switch-pro">
                    </label>
                </div>

                <div class="setting-item-pro">
                    <label class="setting-label-pro">
                        <span>AUTO-SCALE</span>
                        <input type="checkbox" id="auto-scale" checked class="toggle-switch-pro">
                    </label>
                </div>

                <button onclick="saveDisplaySettings()" class="btn-pro btn-secondary" style="width: 100%; margin-top: 0.25rem;">
                    <svg class="btn-icon" viewBox="0 0 24 24"><path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/></svg>
                    SAVE DISPLAY SETTINGS
                </button>
            </div>
        </div>

        <!-- System Information -->
        <div class="control-bar glass-pro" style="padding: 1rem;">
            <h2 style="font-size: 0.85rem; font-weight: 700; margin-bottom: 0.65rem; color: var(--accent-green); letter-spacing: 1px;">
                <svg style="display: inline-block; width: 16px; height: 16px; margin-right: 0.4rem; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M13 2.05v3.03c3.39.49 6 3.39 6 6.92 0 .9-.18 1.75-.48 2.54l2.6 1.53c.56-1.24.88-2.62.88-4.07 0-5.18-3.95-9.45-9-9.95zM12 19c-3.87 0-7-3.13-7-7 0-3.53 2.61-6.43 6-6.92V2.05c-5.06.5-9 4.76-9 9.95 0 5.52 4.47 10 9.99 10 3.31 0 6.24-1.61 8.06-4.09l-2.6-1.53C16.17 17.98 14.21 19 12 19z"/>
                </svg>
                SYSTEM INFORMATION
            </h2>

            <div style="display: flex; flex-direction: column; gap: 0.5rem; font-family: var(--font-primary);">
                <div style="display: flex; justify-content: space-between; padding: 0.6rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <span style="color: var(--text-secondary); font-size: 0.75rem;">APPLICATION</span>
                    <span style="color: var(--text-primary); font-size: 0.75rem; font-weight: 600;">FNIRSI FNB58 Pro</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.6rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <span style="color: var(--text-secondary); font-size: 0.75rem;">VERSION</span>
                    <span style="color: var(--text-primary); font-size: 0.75rem; font-weight: 600;">2.0.0</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.6rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <span style="color: var(--text-secondary); font-size: 0.75rem;">PLATFORM</span>
                    <span style="color: var(--text-primary); font-size: 0.75rem; font-weight: 600;" id="platform-info">WEB</span>
                </div>
                <div style="display: flex; justify-content: space-between; padding: 0.6rem; background: var(--bg-tertiary); border-radius: 4px;">
                    <span style="color: var(--text-secondary); font-size: 0.75rem;">BROWSER</span>
                    <span style="color: var(--text-primary); font-size: 0.75rem; font-weight: 600;" id="browser-info">--</span>
                </div>
            </div>
        </div>

    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Load thresholds on page load
document.addEventListener('DOMContentLoaded', () => {
    loadThresholds();
    loadSystemInfo();
});

// Load current thresholds
async function loadThresholds() {
    try {
        const response = await fetch('/api/thresholds');
        const result = await response.json();

        if (result.success) {
            const thresholds = result.thresholds;
            document.getElementById('threshold-max-voltage').value = thresholds.max_voltage || 21.0;
            document.getElementById('threshold-min-voltage').value = thresholds.min_voltage || 3.0;
            document.getElementById('threshold-max-current').value = thresholds.max_current || 6.0;
            document.getElementById('threshold-max-power').value = thresholds.max_power || 120.0;
            document.getElementById('threshold-max-temp').value = thresholds.max_temperature || 80.0;
        }
    } catch (error) {
        console.error('Failed to load thresholds:', error);
    }
}

// Save thresholds
async function saveThresholds() {
    const thresholds = {
        max_voltage: parseFloat(document.getElementById('threshold-max-voltage').value),
        min_voltage: parseFloat(document.getElementById('threshold-min-voltage').value),
        max_current: parseFloat(document.getElementById('threshold-max-current').value),
        max_power: parseFloat(document.getElementById('threshold-max-power').value),
        max_temperature: parseFloat(document.getElementById('threshold-max-temp').value)
    };

    try {
        for (const [name, value] of Object.entries(thresholds)) {
            await fetch('/api/thresholds', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, value })
            });
        }

        showToast('Thresholds saved successfully', 'success');
    } catch (error) {
        showToast('Failed to save thresholds', 'error');
    }
}

// Scan for Bluetooth devices
async function scanBluetooth() {
    const button = document.getElementById('btn-scan');
    const resultsDiv = document.getElementById('scan-results');

    button.disabled = true;
    button.textContent = 'SCANNING...';
    resultsDiv.innerHTML = '<div style="text-align: center; color: var(--accent-blue); padding: 2rem; font-size: 0.8rem;">Scanning for devices...</div>';

    try {
        const response = await fetch('/api/scan-bluetooth');
        const result = await response.json();

        if (result.success && result.devices.length > 0) {
            resultsDiv.innerHTML = '';
            result.devices.forEach(device => {
                const deviceCard = document.createElement('div');
                deviceCard.style.cssText = 'padding: 1rem; background: var(--bg-tertiary); border-radius: 4px; cursor: pointer; border: 1px solid var(--border-primary); transition: all 0.2s;';
                deviceCard.onmouseenter = () => {
                    deviceCard.style.borderColor = 'var(--accent-blue)';
                    deviceCard.style.background = 'var(--bg-secondary)';
                };
                deviceCard.onmouseleave = () => {
                    deviceCard.style.borderColor = 'var(--border-primary)';
                    deviceCard.style.background = 'var(--bg-tertiary)';
                };
                deviceCard.onclick = () => connectBluetoothDevice(device.address);

                deviceCard.innerHTML = `
                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem; font-size: 0.85rem;">${device.name || 'Unknown Device'}</div>
                    <div style="font-size: 0.75rem; color: var(--text-tertiary); font-family: monospace;">${device.address}</div>
                    ${device.rssi ? `<div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 0.25rem;">Signal: ${device.rssi} dBm</div>` : ''}
                `;
                resultsDiv.appendChild(deviceCard);
            });
        } else {
            resultsDiv.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: 2rem; font-size: 0.8rem;">No devices found</div>';
        }
    } catch (error) {
        resultsDiv.innerHTML = '<div style="text-align: center; color: var(--accent-red); padding: 2rem; font-size: 0.8rem;">Scan failed</div>';
    }

    button.disabled = false;
    button.innerHTML = '<svg class="btn-icon" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>SCAN FOR DEVICES';
}

// Connect to Bluetooth device
function connectBluetoothDevice(address) {
    window.location.href = '/dashboard?connect=bluetooth&address=' + address;
}

// Connect using manually entered address
function connectManualAddress() {
    const address = document.getElementById('bt-address').value.trim();
    if (!address) {
        alert('Please enter a Bluetooth device address');
        return;
    }
    // Validate address format (XX:XX:XX:XX:XX:XX)
    const addressPattern = /^([0-9A-Fa-f]{2}:){5}[0-9A-Fa-f]{2}$/;
    if (!addressPattern.test(address)) {
        alert('Invalid address format. Use format: XX:XX:XX:XX:XX:XX');
        return;
    }
    // Save to localStorage for future use
    localStorage.setItem('fnirsi_bt_address', address);
    // Navigate to dashboard and connect
    window.location.href = '/dashboard?connect=bluetooth&address=' + address;
}

// Load saved address on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedAddress = localStorage.getItem('fnirsi_bt_address');
    if (savedAddress) {
        document.getElementById('bt-address').value = savedAddress;
    }
});

// Save display settings
function saveDisplaySettings() {
    const settings = {
        updateRate: document.getElementById('update-rate').value,
        chartAnimation: document.getElementById('chart-animation').value,
        maxPoints: document.getElementById('max-points').value,
        showGrid: document.getElementById('show-grid').checked,
        autoScale: document.getElementById('auto-scale').checked
    };

    localStorage.setItem('displaySettings', JSON.stringify(settings));
    showToast('Display settings saved', 'success');
}

// Load system info
function loadSystemInfo() {
    const browserEl = document.getElementById('browser-info');
    if (browserEl) {
        const ua = navigator.userAgent;
        let browser = 'Unknown';
        if (ua.includes('Chrome')) browser = 'Chrome';
        else if (ua.includes('Safari')) browser = 'Safari';
        else if (ua.includes('Firefox')) browser = 'Firefox';
        else if (ua.includes('Edge')) browser = 'Edge';
        browserEl.textContent = browser;
    }

    const platformEl = document.getElementById('platform-info');
    if (platformEl) {
        platformEl.textContent = navigator.platform || 'WEB';
    }
}

// Toast notification
function showToast(message, type = 'info') {
    console.log(`[${type}] ${message}`);
    if (typeof showToastPro === 'function') {
        showToastPro(message, type);
    }
}
</script>

<style>
.setting-item-pro {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.setting-label-pro {
    font-size: 0.7rem;
    font-weight: 600;
    color: var(--text-secondary);
    letter-spacing: 0.5px;
    text-transform: uppercase;
    margin-bottom: 0;
}

.setting-input-pro {
    padding: 0.5rem 0.65rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    color: var(--text-primary);
    font-family: var(--font-primary);
    font-size: 0.8rem;
    transition: all 0.2s;
}

.setting-input-pro:focus {
    outline: none;
    border-color: var(--accent-blue);
    box-shadow: 0 0 0 2px rgba(0, 217, 255, 0.1);
}

.setting-input-pro:hover {
    border-color: var(--border-accent);
}

.toggle-switch-pro {
    width: 40px;
    height: 20px;
    appearance: none;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 10px;
    position: relative;
    cursor: pointer;
    transition: all 0.3s;
    flex-shrink: 0;
}

.toggle-switch-pro::before {
    content: '';
    position: absolute;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--text-tertiary);
    top: 2px;
    left: 2px;
    transition: all 0.3s;
}

.toggle-switch-pro:checked {
    background: var(--accent-blue);
    border-color: var(--accent-blue);
}

.toggle-switch-pro:checked::before {
    left: 22px;
    background: white;
}

.setting-item-pro label:has(.toggle-switch-pro) {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
}
</style>
{% endblock %}
