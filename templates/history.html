{% extends "base.html" %}

{% block title %}Session History - FNIRSI FNB58 Monitor{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <h1 class="text-3xl font-bold">Session History</h1>
        <button onclick="loadSessions()" 
                class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
            üîÑ Refresh
        </button>
    </div>
    
    <!-- Sessions List -->
    <div id="sessions-container" class="space-y-4">
        <div class="text-center text-gray-400 py-12">
            <p class="text-lg">Loading sessions...</p>
        </div>
    </div>
    
    <!-- Session Viewer Modal -->
    <div id="session-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
        <div class="glass rounded-lg max-w-6xl w-full max-h-[90vh] overflow-auto">
            <div class="sticky top-0 glass border-b border-gray-700 p-6 flex items-center justify-between">
                <h2 class="text-2xl font-bold" id="modal-title">Session Details</h2>
                <button onclick="closeSessionModal()" class="text-2xl hover:text-red-500">‚úï</button>
            </div>
            
            <div class="p-6">
                <!-- Session Info -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="glass rounded-lg p-4">
                        <div class="text-xs text-gray-400 uppercase">Duration</div>
                        <div class="text-lg font-bold" id="session-duration">-</div>
                    </div>
                    <div class="glass rounded-lg p-4">
                        <div class="text-xs text-gray-400 uppercase">Samples</div>
                        <div class="text-lg font-bold" id="session-samples">-</div>
                    </div>
                    <div class="glass rounded-lg p-4">
                        <div class="text-xs text-gray-400 uppercase">Energy</div>
                        <div class="text-lg font-bold" id="session-energy">-</div>
                    </div>
                    <div class="glass rounded-lg p-4">
                        <div class="text-xs text-gray-400 uppercase">Capacity</div>
                        <div class="text-lg font-bold" id="session-capacity">-</div>
                    </div>
                </div>
                
                <!-- Session Chart -->
                <div class="glass rounded-lg p-6 mb-6">
                    <canvas id="session-chart" height="300"></canvas>
                </div>
                
                <!-- Statistics -->
                <div class="glass rounded-lg p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">Statistics</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-2">Voltage</h4>
                            <div class="space-y-1 text-sm">
                                <div>Min: <span id="stat-v-min" class="font-mono">-</span> V</div>
                                <div>Max: <span id="stat-v-max" class="font-mono">-</span> V</div>
                                <div>Avg: <span id="stat-v-avg" class="font-mono">-</span> V</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-2">Current</h4>
                            <div class="space-y-1 text-sm">
                                <div>Min: <span id="stat-c-min" class="font-mono">-</span> A</div>
                                <div>Max: <span id="stat-c-max" class="font-mono">-</span> A</div>
                                <div>Avg: <span id="stat-c-avg" class="font-mono">-</span> A</div>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-sm font-semibold text-gray-400 mb-2">Power</h4>
                            <div class="space-y-1 text-sm">
                                <div>Max: <span id="stat-p-max" class="font-mono">-</span> W</div>
                                <div>Avg: <span id="stat-p-avg" class="font-mono">-</span> W</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Export Options -->
                <div class="flex justify-between items-center">
                    <button onclick="deleteCurrentSession()"
                            class="px-6 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        üóëÔ∏è Delete Session
                    </button>
                    <div class="flex gap-2">
                        <button onclick="exportSessionCSV()"
                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                            üì• Export CSV
                        </button>
                        <button onclick="exportSessionHTML()"
                                class="px-6 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                            üìÑ Export HTML
                        </button>
                        <button onclick="exportSessionJSON()"
                                class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                            üì• Export JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let sessions = [];
let currentSession = null;
let sessionChart = null;

// Load sessions from server
async function loadSessions() {
    try {
        const result = await apiRequest('/api/sessions');
        
        if (result.success) {
            sessions = result.sessions;
            displaySessions();
        }
    } catch (error) {
        showToast(`Failed to load sessions: ${error.message}`, 'error');
    }
}

// Display sessions list
function displaySessions() {
    const container = document.getElementById('sessions-container');
    
    if (sessions.length === 0) {
        container.innerHTML = `
            <div class="text-center text-gray-400 py-12">
                <p class="text-lg">No sessions found</p>
                <p class="text-sm mt-2">Start recording to create your first session</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = sessions.map(session => `
        <div class="glass rounded-lg p-6 hover:border-blue-500 border border-transparent transition cursor-pointer"
             onclick="viewSession('${session.filename}')">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold mb-2">
                        ${new Date(session.start_time).toLocaleString()}
                    </h3>
                    <div class="flex gap-4 text-sm text-gray-400">
                        <span>üìä ${session.samples} samples</span>
                        <span>üîå ${session.connection_type?.toUpperCase()}</span>
                        <span>‚è±Ô∏è ${calculateDuration(session.start_time, session.end_time)}</span>
                    </div>
                </div>
                <div class="text-3xl">üìà</div>
            </div>
        </div>
    `).join('');
}

// Calculate duration between timestamps
function calculateDuration(start, end) {
    const startTime = new Date(start);
    const endTime = new Date(end);
    const seconds = (endTime - startTime) / 1000;
    return formatDuration(seconds);
}

// View session details
async function viewSession(filename) {
    try {
        const result = await apiRequest(`/api/sessions/${filename}`);
        
        if (result.success) {
            currentSession = result.session;
            displaySessionModal();
        }
    } catch (error) {
        showToast(`Failed to load session: ${error.message}`, 'error');
    }
}

// Display session in modal
function displaySessionModal() {
    const modal = document.getElementById('session-modal');
    const stats = currentSession.stats || {};
    
    // Update title
    document.getElementById('modal-title').textContent = 
        `Session: ${new Date(currentSession.start_time).toLocaleString()}`;
    
    // Update info
    const duration = calculateDuration(currentSession.start_time, currentSession.end_time);
    document.getElementById('session-duration').textContent = duration;
    document.getElementById('session-samples').textContent = stats.samples_collected || 0;
    document.getElementById('session-energy').textContent = 
        formatNumber(stats.total_energy_wh || 0, 4) + ' Wh';
    document.getElementById('session-capacity').textContent = 
        formatNumber(stats.total_capacity_ah * 1000 || 0, 2) + ' mAh';
    
    // Update statistics
    document.getElementById('stat-v-min').textContent = formatNumber(stats.min_voltage || 0, 5);
    document.getElementById('stat-v-max').textContent = formatNumber(stats.max_voltage || 0, 5);
    document.getElementById('stat-v-avg').textContent = formatNumber(stats.avg_voltage || 0, 5);
    document.getElementById('stat-c-min').textContent = formatNumber(stats.min_current || 0, 5);
    document.getElementById('stat-c-max').textContent = formatNumber(stats.max_current || 0, 5);
    document.getElementById('stat-c-avg').textContent = formatNumber(stats.avg_current || 0, 5);
    document.getElementById('stat-p-max').textContent = formatNumber(stats.max_power || 0, 5);
    document.getElementById('stat-p-avg').textContent = formatNumber(stats.avg_power || 0, 5);
    
    // Create chart
    createSessionChart();
    
    modal.classList.remove('hidden');
}

// Create chart for session
function createSessionChart() {
    const ctx = document.getElementById('session-chart');
    
    if (sessionChart) {
        sessionChart.destroy();
    }
    
    const data = currentSession.data || [];
    
    sessionChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Voltage (V)',
                    data: data.map((d, i) => ({ x: i, y: d.voltage })),
                    borderColor: '#3b82f6',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y'
                },
                {
                    label: 'Current (A)',
                    data: data.map((d, i) => ({ x: i, y: d.current })),
                    borderColor: '#10b981',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y1'
                },
                {
                    label: 'Power (W)',
                    data: data.map((d, i) => ({ x: i, y: d.power })),
                    borderColor: '#f59e0b',
                    borderWidth: 2,
                    pointRadius: 0,
                    yAxisID: 'y2'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    labels: { color: '#cbd5e1' }
                }
            },
            scales: {
                x: {
                    type: 'linear',
                    display: false
                },
                y: {
                    type: 'linear',
                    position: 'left',
                    ticks: { color: '#94a3b8' },
                    grid: { color: 'rgba(148, 163, 184, 0.1)' }
                },
                y1: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#94a3b8' },
                    grid: { drawOnChartArea: false }
                },
                y2: {
                    type: 'linear',
                    position: 'right',
                    ticks: { color: '#94a3b8' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
}

// Close session modal
function closeSessionModal() {
    document.getElementById('session-modal').classList.add('hidden');
    if (sessionChart) {
        sessionChart.destroy();
        sessionChart = null;
    }
}

// Export session as CSV
function exportSessionCSV() {
    if (currentSession && currentSession.data) {
        exportDataToCSV(currentSession.data);
    }
}

// Export session as JSON
function exportSessionJSON() {
    if (currentSession) {
        const json = JSON.stringify(currentSession, null, 2);
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        downloadFile(json, `fnirsi_session_${timestamp}.json`, 'application/json');
        showToast('Session exported as JSON', 'success');
    }
}

// Delete current session
let currentSessionFilename = null;

async function deleteCurrentSession() {
    if (!currentSessionFilename) return;

    if (!confirm('Are you sure you want to delete this session?\n\nThis action cannot be undone.')) {
        return;
    }

    try {
        const result = await apiRequest(`/api/sessions/${currentSessionFilename}`, {
            method: 'DELETE'
        });

        if (result.success) {
            showToast('Session deleted successfully', 'success');
            closeSessionModal();
            loadSessions(); // Reload list
        } else {
            showToast('Failed to delete session: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Failed to delete session: ' + error.message, 'error');
    }
}

// Update viewSession to store filename
const originalViewSession = viewSession;
viewSession = async function(filename) {
    currentSessionFilename = filename;
    await originalViewSession(filename);
};

// Load sessions on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSessions();
});
</script>
{% endblock %}
