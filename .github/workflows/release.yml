name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libusb-1.0-0-dev

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-mock pytest-asyncio

      - name: Run tests
        run: pytest tests/ -v --tb=short -p no:azurepipelines

  release:
    needs: test
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Verify version matches pyproject.toml
        run: |
          TOML_VERSION=$(python -c "
          import re
          with open('pyproject.toml') as f:
              match = re.search(r'version\s*=\s*\"(.+?)\"', f.read())
              print(match.group(1))
          ")
          if [ "$TOML_VERSION" != "${{ steps.version.outputs.VERSION }}" ]; then
            echo "::error::Tag version (${{ steps.version.outputs.VERSION }}) does not match pyproject.toml ($TOML_VERSION)"
            exit 1
          fi

      - name: Extract changelog for this version
        id: changelog
        run: |
          # Extract the section for the current version from CHANGELOG.md
          VERSION="${{ steps.version.outputs.VERSION }}"
          NOTES=$(python -c "
          import re
          with open('CHANGELOG.md') as f:
              content = f.read()
          # Match from ## [VERSION] to the next ## [ or end of file
          pattern = r'## \[' + re.escape('$VERSION') + r'\].*?\n(.*?)(?=\n## \[|\Z)'
          match = re.search(pattern, content, re.DOTALL)
          if match:
              print(match.group(1).strip())
          else:
              print('Release $VERSION')
          ")
          # Write to file to preserve multiline content
          echo "$NOTES" > release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          generate_release_notes: false
